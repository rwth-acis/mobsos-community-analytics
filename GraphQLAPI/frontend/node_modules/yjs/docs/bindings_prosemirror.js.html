

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: bindings/prosemirror.js | yjs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="./style.css">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 162px; height: 162px">
        
            <a href="/" rel="noopener noreferrer" target="_blank">
                <img src="https://user-images.githubusercontent.com/5553757/48975307-61efb100-f06d-11e8-9177-ee895e5916e5.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">yjs</a></h1>
        
            <span class="version">v13.0.0-76</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
        <ol class="lnb-tab">
            <li id="api-tab">
                <a href="#"><h4>API</h4></a>
            </li>
            <li id="examples-tab">
                <a href="#"><h4>Examples</h4></a>
            </li>
        </ol>
    
    <div class="lnb-examples hidden"><h3>Examples</h3><ul><li><a href="tutorial-codemirror.html">CodeMirror Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="codemirror_sub"></div></li><li><a href="tutorial-dom.html">Dom Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="dom_sub"></div></li><li><a href="tutorial-prosemirror.html">ProseMirror Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="prosemirror_sub"></div></li><li><a href="tutorial-quill.html">Quill Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="quill_sub"></div></li><li><a href="tutorial-textarea.html">Textarea Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="textarea_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-bindings_dom.html">bindings/dom</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/dom_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-bindings_dom.html#.defaultFilter">defaultFilter</a></li><li><a href="module-bindings_dom.html#.domToType">domToType</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-bindings_dom.html#~DomFilter">DomFilter</a></li><li><a href="module-bindings_dom.html#~DomFilter">DomFilter</a></li><li><a href="module-bindings_dom.html#~FilterFunction">FilterFunction</a></li></ul></div></li><li><a href="module-bindings_prosemirror.html">bindings/prosemirror</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/prosemirror_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_prosemirror.html#.absolutePositionToRelativePosition">absolutePositionToRelativePosition</a></li><li><a href="module-bindings_prosemirror.html#.createNodeIfNotExists">createNodeIfNotExists</a></li><li><a href="module-bindings_prosemirror.html#.cursorPlugin">cursorPlugin</a></li><li><a href="module-bindings_prosemirror.html#.cursorPluginKey">cursorPluginKey</a></li><li><a href="module-bindings_prosemirror.html#.prosemirrorPlugin">prosemirrorPlugin</a></li><li><a href="module-bindings_prosemirror.html#.prosemirrorPluginKey">prosemirrorPluginKey</a></li><li><a href="module-bindings_prosemirror.html#.relativePositionToAbsolutePosition">relativePositionToAbsolutePosition</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-bindings_prosemirror.html#~matchNodeName">matchNodeName</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-bindings_prosemirror.html#~ProsemirrorMapping">ProsemirrorMapping</a></li></ul></div></li><li><a href="module-bindings_quill.html">bindings/quill</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/quill_sub"></div></li><li><a href="module-bindings_textarea.html">bindings/textarea</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/textarea_sub"></div></li><li><a href="module-provider_websocket.html">provider/websocket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/websocket_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_websocket.html#~permissionDeniedHandler">permissionDeniedHandler</a></li><li><a href="module-provider_websocket.html#~readMessage">readMessage</a></li></ul></div></li><li><a href="module-provider_websocket_server.html">provider/websocket/server</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/websocket/server_sub"></div></li><li><a href="module-provider_ydb.html">provider/ydb</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/ydb_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-provider_ydb.html#._broadcastYdbCUConfConfirmed">_broadcastYdbCUConfConfirmed</a></li><li><a href="module-provider_ydb.html#._broadcastYdbCUConfCreated">_broadcastYdbCUConfCreated</a></li><li><a href="module-provider_ydb.html#._broadcastYdbRemoteOffsetConfirmed">_broadcastYdbRemoteOffsetConfirmed</a></li><li><a href="module-provider_ydb.html#._broadcastYdbRemoteOffsetReceived">_broadcastYdbRemoteOffsetReceived</a></li><li><a href="module-provider_ydb.html#._broadcastYdbSyncFromServer">_broadcastYdbSyncFromServer</a></li><li><a href="module-provider_ydb.html#._broadcastYdbSyncingRoomsToServer">_broadcastYdbSyncingRoomsToServer</a></li><li><a href="module-provider_ydb.html#.clear">clear</a></li><li><a href="module-provider_ydb.html#.confirmClient">confirmClient</a></li><li><a href="module-provider_ydb.html#.confirmSubscription">confirmSubscription</a></li><li><a href="module-provider_ydb.html#.createSub">createSub</a></li><li><a href="module-provider_ydb.html#.createTransaction">createTransaction</a></li><li><a href="module-provider_ydb.html#.createUpdate">createUpdate</a></li><li><a href="module-provider_ydb.html#.createYdbClient">createYdbClient</a></li><li><a href="module-provider_ydb.html#.get">get</a></li><li><a href="module-provider_ydb.html#.getRoomData">getRoomData</a></li><li><a href="module-provider_ydb.html#.getRoomDataWithoutCU">getRoomDataWithoutCU</a></li><li><a href="module-provider_ydb.html#.getRoomMetas">getRoomMetas</a></li><li><a href="module-provider_ydb.html#.getUnconfirmedUpdates">getUnconfirmedUpdates</a></li><li><a href="module-provider_ydb.html#.openDB">openDB</a></li><li><a href="module-provider_ydb.html#.publishAll">publishAll</a></li><li><a href="module-provider_ydb.html#.publishRoomData">publishRoomData</a></li><li><a href="module-provider_ydb.html#.readMessage">readMessage</a></li><li><a href="module-provider_ydb.html#.send">send</a></li><li><a href="module-provider_ydb.html#.subscribeRoomData">subscribeRoomData</a></li><li><a href="module-provider_ydb.html#.update">update</a></li><li><a href="module-provider_ydb.html#.writeClientUnconfirmed">writeClientUnconfirmed</a></li><li><a href="module-provider_ydb.html#.writeConfirmedByHost">writeConfirmedByHost</a></li><li><a href="module-provider_ydb.html#.writeHostUnconfirmed">writeHostUnconfirmed</a></li><li><a href="module-provider_ydb.html#.writeHostUnconfirmedByClient">writeHostUnconfirmedByClient</a></li><li><a href="module-provider_ydb.html#~datasubs">datasubs</a></li><li><a href="module-provider_ydb.html#~ydbinstances">ydbinstances</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_ydb.html#~checkTestClients">checkTestClients</a></li><li><a href="module-provider_ydb.html#~decodeHUKey">decodeHUKey</a></li><li><a href="module-provider_ydb.html#~encodeHUKey">encodeHUKey</a></li><li><a href="module-provider_ydb.html#~encodeMetaValue">encodeMetaValue</a></li><li><a href="module-provider_ydb.html#~getStoreCo">getStoreCo</a></li><li><a href="module-provider_ydb.html#~getStoreCU">getStoreCU</a></li><li><a href="module-provider_ydb.html#~getStoreHU">getStoreHU</a></li><li><a href="module-provider_ydb.html#~getStoreUS">getStoreUS</a></li><li><a href="module-provider_ydb.html#~getTestClient">getTestClient</a></li><li><a href="module-provider_ydb.html#~initWS">initWS</a></li><li><a href="module-provider_ydb.html#~update">update</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-provider_ydb.html#~HUTableKey">HUTableKey</a></li><li><a href="module-provider_ydb.html#~RoomAndOffset">RoomAndOffset</a></li><li><a href="module-provider_ydb.html#~RoomMeta">RoomMeta</a></li><li><a href="module-provider_ydb.html#~RoomState">RoomState</a></li><li><a href="module-provider_ydb.html#~Sub">Sub</a></li><li><a href="module-provider_ydb.html#~SubDef">SubDef</a></li><li><a href="module-provider_ydb.html#~SyncState">SyncState</a></li></ul></div></li><li><a href="module-structs.html">structs</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:structs_sub"></div></li><li><a href="module-types.html">types</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types_sub"><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-types.html#~CSS_Selector">CSS_Selector</a></li><li><a href="module-types.html#~CSS_Selector">CSS_Selector</a></li><li><a href="module-types.html#~Delta">Delta</a></li><li><a href="module-types.html#~domFilter">domFilter</a></li><li><a href="module-types.html#~TextAttributes">TextAttributes</a></li></ul></div></li><li><a href="module-utils.html">utils</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:utils_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="module-bindings_dom.DomBinding.html">DomBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/dom.DomBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_dom.DomBinding.html#domToType">domToType</a></li><li><a href="module-bindings_dom.DomBinding.html#filter">filter</a></li><li><a href="module-bindings_dom.DomBinding.html#target">target</a></li><li><a href="module-bindings_dom.DomBinding.html#type">type</a></li><li><a href="module-bindings_dom.DomBinding.html#typeToDom">typeToDom</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-bindings_dom.DomBinding.html#destroy">destroy</a></li><li><a href="module-bindings_dom.DomBinding.html#setFilter">setFilter</a></li></ul></div></li><li><a href="module-bindings_prosemirror.ProsemirrorBinding.html">ProsemirrorBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/prosemirror.ProsemirrorBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_prosemirror.ProsemirrorBinding.html#_relSelection">_relSelection</a></li><li><a href="module-bindings_prosemirror.ProsemirrorBinding.html#mapping">mapping</a></li></ul></div></li><li><a href="module-bindings_quill.QuillBinding.html">QuillBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/quill.QuillBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_quill.QuillBinding.html#target">target</a></li><li><a href="module-bindings_quill.QuillBinding.html#type">type</a></li></ul></div></li><li><a href="module-bindings_textarea.CodeMirrorBinding.html">CodeMirrorBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/textarea.CodeMirrorBinding_sub"></div></li><li><a href="module-bindings_textarea.TextareaBinding.html">TextareaBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/textarea.TextareaBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_textarea.TextareaBinding.html#target">target</a></li><li><a href="module-bindings_textarea.TextareaBinding.html#type">type</a></li></ul></div></li><li><a href="module-provider_websocket.WebsocketProvider.html">WebsocketProvider</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/websocket.WebsocketProvider_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-provider_websocket.WebsocketProvider.html#docs">docs</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_websocket.WebsocketProvider.html#get">get</a></li></ul></div></li><li><a href="module-provider_ydb.YdbClient.html">YdbClient</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/ydb.YdbClient_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-provider_ydb.YdbClient.html#clientUnconfirmedStates">clientUnconfirmedStates</a></li><li><a href="module-provider_ydb.YdbClient.html#roomStates">roomStates</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_ydb.YdbClient.html#getY">getY</a></li></ul></div></li><li><a href="module-structs.Type.html">Type</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:structs.Type_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-structs.Type.html#_first">_first</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-structs.Type.html#getPathTo">getPathTo</a></li><li><a href="module-structs.Type.html#observe">observe</a></li><li><a href="module-structs.Type.html#observeDeep">observeDeep</a></li><li><a href="module-structs.Type.html#toJSON">toJSON</a></li><li><a href="module-structs.Type.html#unobserve">unobserve</a></li><li><a href="module-structs.Type.html#unobserveDeep">unobserveDeep</a></li></ul></div></li><li><a href="module-types.YArray.html">YArray</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YArray_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YArray.html#delete">delete</a></li><li><a href="module-types.YArray.html#forEach">forEach</a></li><li><a href="module-types.YArray.html#get">get</a></li><li><a href="module-types.YArray.html#insert">insert</a></li><li><a href="module-types.YArray.html#map">map</a></li><li><a href="module-types.YArray.html#push">push</a></li><li><a href="module-types.YArray.html#toArray">toArray</a></li><li><a href="module-types.YArray.html#toJSON">toJSON</a></li></ul></div></li><li><a href="module-types.YArrayEvent.html">YArrayEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YArrayEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-types.YArrayEvent.html#addedElements">addedElements</a></li><li><a href="module-types.YArrayEvent.html#removedElements">removedElements</a></li></ul></div></li><li><a href="module-types.YMap.html">YMap</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YMap_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YMap.html#delete">delete</a></li><li><a href="module-types.YMap.html#get">get</a></li><li><a href="module-types.YMap.html#has">has</a></li><li><a href="module-types.YMap.html#keys">keys</a></li><li><a href="module-types.YMap.html#set">set</a></li><li><a href="module-types.YMap.html#toJSON">toJSON</a></li></ul></div></li><li><a href="module-types.YMapEvent.html">YMapEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YMapEvent_sub"></div></li><li><a href="module-types.YText.html">YText</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YText_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YText.html#applyDelta">applyDelta</a></li><li><a href="module-types.YText.html#delete">delete</a></li><li><a href="module-types.YText.html#format">format</a></li><li><a href="module-types.YText.html#insert">insert</a></li><li><a href="module-types.YText.html#insertEmbed">insertEmbed</a></li><li><a href="module-types.YText.html#toDelta">toDelta</a></li><li><a href="module-types.YText.html#toString">toString</a></li></ul></div></li><li><a href="module-types.YXmlElement.html">YXmlElement</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlElement_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlElement.html#getAttribute">getAttribute</a></li><li><a href="module-types.YXmlElement.html#getAttributes">getAttributes</a></li><li><a href="module-types.YXmlElement.html#removeAttribute">removeAttribute</a></li><li><a href="module-types.YXmlElement.html#setAttribute">setAttribute</a></li><li><a href="module-types.YXmlElement.html#toDom">toDom</a></li><li><a href="module-types.YXmlElement.html#toDomString">toDomString</a></li></ul></div></li><li><a href="module-types.YXmlEvent.html">YXmlEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-types.YXmlEvent.html#_transaction">_transaction</a></li><li><a href="module-types.YXmlEvent.html#attributesChanged">attributesChanged</a></li><li><a href="module-types.YXmlEvent.html#childListChanged">childListChanged</a></li><li><a href="module-types.YXmlEvent.html#remote">remote</a></li></ul></div></li><li><a href="module-types.YXmlFragment.html">YXmlFragment</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlFragment_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlFragment.html#createTreeWalker">createTreeWalker</a></li><li><a href="module-types.YXmlFragment.html#querySelector">querySelector</a></li><li><a href="module-types.YXmlFragment.html#querySelectorAll">querySelectorAll</a></li><li><a href="module-types.YXmlFragment.html#toDom">toDom</a></li><li><a href="module-types.YXmlFragment.html#toDomString">toDomString</a></li></ul></div></li><li><a href="module-types.YXmlHook.html">YXmlHook</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlHook_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlHook.html#toDom">toDom</a></li></ul></div></li><li><a href="module-types.YXmlText.html">YXmlText</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlText_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlText.html#toDom">toDom</a></li></ul></div></li><li><a href="module-types.YXmlTreeWalker.html">YXmlTreeWalker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlTreeWalker_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlTreeWalker.html#next">next</a></li></ul></div></li><li><a href="module-utils.YEvent.html">YEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:utils.YEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-utils.YEvent.html#currentTarget">currentTarget</a></li><li><a href="module-utils.YEvent.html#path">path</a></li><li><a href="module-utils.YEvent.html#target">target</a></li></ul></div></li><li><a href="UndoManager.html">UndoManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UndoManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="UndoManager.html#flushChanges">flushChanges</a></li><li><a href="UndoManager.html#redo">redo</a></li><li><a href="UndoManager.html#undo">undo</a></li></ul></div></li><li><a href="Y.html">Y</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Y_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Y.html#define">define</a></li><li><a href="Y.html#destroy">destroy</a></li><li><a href="Y.html#exportModel">exportModel</a></li><li><a href="Y.html#get">get</a></li><li><a href="Y.html#importModel">importModel</a></li><li><a href="Y.html#transact">transact</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3><a href="global.html">Global</a></h3></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module bindings/prosemirror
 */

import { YText } from '../types/YText.js' // eslint-disable-line
import { YXmlElement, YXmlFragment } from '../types/YXmlElement.js' // eslint-disable-line
import { createMutex } from '../lib/mutex.js'
import * as PModel from 'prosemirror-model'
import { EditorView,  Decoration, DecorationSet } from 'prosemirror-view' // eslint-disable-line
import { Plugin, PluginKey, EditorState, TextSelection } from 'prosemirror-state' // eslint-disable-line
import * as math from '../lib/math.js'
import * as object from '../lib/object.js'
import * as YPos from '../utils/relativePosition.js'

/**
 * @typedef {Map&lt;YText | YXmlElement | YXmlFragment, PModel.Node>} ProsemirrorMapping
 */

/**
 * The unique prosemirror plugin key for prosemirrorPlugin.
 *
 * @public
 */
export const prosemirrorPluginKey = new PluginKey('yjs')

/**
 * This plugin listens to changes in prosemirror view and keeps yXmlState and view in sync.
 *
 * This plugin also keeps references to the type and the shared document so other plugins can access it.
 * @param {YXmlFragment} yXmlFragment
 * @return {Plugin} Returns a prosemirror plugin that binds to this type
 */
export const prosemirrorPlugin = yXmlFragment => {
  const pluginState = {
    type: yXmlFragment,
    y: yXmlFragment._y,
    binding: null
  }
  let changedInitialContent = false
  const plugin = new Plugin({
    key: prosemirrorPluginKey,
    state: {
      init: (initargs, state) => {
        return pluginState
      },
      apply: (tr, pluginState) => {
        // update Yjs state when apply is called. We need to do this here to compute the correct cursor decorations with the cursor plugin
        if (pluginState.binding !== null &amp;&amp; (changedInitialContent || tr.doc.content.size > 4)) {
          changedInitialContent = true
          pluginState.binding._prosemirrorChanged(tr.doc)
        }
        return pluginState
      }
    },
    view: view => {
      const binding = new ProsemirrorBinding(yXmlFragment, view)
      pluginState.binding = binding
      return {
        update: () => {
          if (changedInitialContent || view.state.doc.content.size > 4) {
            changedInitialContent = true
            binding._prosemirrorChanged(view.state.doc)
          }
        },
        destroy: () => {
          binding.destroy()
        }
      }
    }
  })
  return plugin
}

/**
 * The unique prosemirror plugin key for cursorPlugin.type
 *
 * @public
 */
export const cursorPluginKey = new PluginKey('yjs-cursor')

/**
 * A prosemirror plugin that listens to awareness information on Yjs.
 * This requires that a `prosemirrorPlugin` is also bound to the prosemirror.
 *
 * @public
 */
export const cursorPlugin = new Plugin({
  key: cursorPluginKey,
  props: {
    decorations: state => {
      const ystate = prosemirrorPluginKey.getState(state)
      const y = ystate.y
      const awareness = y.getAwarenessInfo()
      const decorations = []
      awareness.forEach((aw, userID) => {
        if (aw.cursor != null) {
          let user = aw.user || {}
          if (user.color == null) {
            user.color = '#ffa500'
          }
          if (user.name == null) {
            user.name = `User: ${userID}`
          }
          let anchor = relativePositionToAbsolutePosition(ystate.type, aw.cursor.anchor || null, ystate.binding.mapping)
          let head = relativePositionToAbsolutePosition(ystate.type, aw.cursor.head || null, ystate.binding.mapping)
          if (anchor !== null &amp;&amp; head !== null) {
            let maxsize = math.max(state.doc.content.size - 1, 0)
            anchor = math.min(anchor, maxsize)
            head = math.min(head, maxsize)
            decorations.push(Decoration.widget(head, () => {
              const cursor = document.createElement('span')
              cursor.classList.add('ProseMirror-yjs-cursor')
              cursor.setAttribute('style', `border-color: ${user.color}`)
              const userDiv = document.createElement('div')
              userDiv.setAttribute('style', `background-color: ${user.color}`)
              userDiv.insertBefore(document.createTextNode(user.name), null)
              cursor.insertBefore(userDiv, null)
              return cursor
            }, { key: userID + '' }))
            const from = math.min(anchor, head)
            const to = math.max(anchor, head)
            decorations.push(Decoration.inline(from, to, { style: `background-color: ${user.color}70` }))
          }
        }
      })
      return DecorationSet.create(state.doc, decorations)
    }
  },
  view: view => {
    const ystate = prosemirrorPluginKey.getState(view.state)
    const y = ystate.y
    const awarenessListener = () => {
      view.updateState(view.state)
    }
    const updateCursorInfo = () => {
      const current = y.getLocalAwarenessInfo()
      if (view.hasFocus()) {
        const anchor = absolutePositionToRelativePosition(view.state.selection.anchor, ystate.type, ystate.binding.mapping)
        const head = absolutePositionToRelativePosition(view.state.selection.head, ystate.type, ystate.binding.mapping)
        if (current.cursor == null || !YPos.equal(current.cursor.anchor, anchor) || !YPos.equal(current.cursor.head, head)) {
          y.setAwarenessField('cursor', {
            anchor, head
          })
        }
      } else if (current.cursor !== null) {
        y.setAwarenessField('cursor', null)
      }
    }
    y.on('awareness', awarenessListener)
    view.dom.addEventListener('focusin', updateCursorInfo)
    view.dom.addEventListener('focusout', updateCursorInfo)
    return {
      update: updateCursorInfo,
      destroy: () => {
        const y = prosemirrorPluginKey.getState(view.state).y
        y.setAwarenessField('cursor', null)
        y.off('awareness', awarenessListener)
      }
    }
  }
})

/**
 * Transforms a Prosemirror based absolute position to a Yjs based relative position.
 *
 * @param {number} pos
 * @param {YXmlFragment} type
 * @param {ProsemirrorMapping} mapping
 * @return {any} relative position
 */
export const absolutePositionToRelativePosition = (pos, type, mapping) => {
  if (pos === 0) {
    return YPos.getRelativePosition(type, 0)
  }
  let n = type._first
  if (n !== null) {
    while (type !== n) {
      const pNodeSize = (mapping.get(n) || { nodeSize: 0 }).nodeSize
      if (n.constructor === YText) {
        if (n.length >= pos) {
          return YPos.getRelativePosition(n, pos)
        } else {
          pos -= n.length
        }
        if (n._next !== null) {
          n = n._next
        } else {
          do {
            n = n._parent
            pos--
          } while (n._next === null &amp;&amp; n !== type)
          if (n !== type) {
            n = n._next
          }
        }
      } else if (n._first !== null &amp;&amp; pos &lt; pNodeSize) {
        n = n._first
        pos--
      } else {
        if (pos === 1 &amp;&amp; n.length === 0 &amp;&amp; pNodeSize > 1) {
          // edge case, should end in this paragraph
          return ['endof', n._id.user, n._id.clock, null, null]
        }
        pos -= pNodeSize
        if (n._next !== null) {
          n = n._next
        } else {
          if (pos === 0) {
            n = n._parent
            return ['endof', n._id.user, n._id.clock || null, n._id.name || null, n._id.type || null]
          }
          do {
            n = n._parent
            pos--
          } while (n._next === null &amp;&amp; n !== type)
          if (n !== type) {
            n = n._next
          }
        }
      }
      if (pos === 0 &amp;&amp; n.constructor !== YText &amp;&amp; n !== type) { // TODO: set to &lt;= 0
        return [n._id.user, n._id.clock]
      }
    }
  }
  return YPos.getRelativePosition(type, type.length)
}

/**
 * @param {YXmlFragment} yDoc Top level type that is bound to pView
 * @param {any} relPos Encoded Yjs based relative position
 * @param {ProsemirrorMapping} mapping
 */
export const relativePositionToAbsolutePosition = (yDoc, relPos, mapping) => {
  const decodedPos = YPos.fromRelativePosition(yDoc._y, relPos)
  if (decodedPos === null) {
    return null
  }
  let type = decodedPos.type
  let pos = 0
  if (type.constructor === YText) {
    pos = decodedPos.offset
  } else if (!type._deleted) {
    let n = type._first
    let i = 0
    while (i &lt; type.length &amp;&amp; i &lt; decodedPos.offset &amp;&amp; n !== null) {
      i++
      pos += mapping.get(n).nodeSize
      n = n._next
    }
    pos += 1 // increase because we go out of n
  }
  while (type !== yDoc) {
    const parent = type._parent
    if (!parent._deleted) {
      pos += 1 // the start tag
      let n = parent._first
      // now iterate until we found type
      while (n !== null) {
        if (n === type) {
          break
        }
        pos += mapping.get(n).nodeSize
        n = n._next
      }
    }
    type = parent
  }
  return pos - 1 // we don't count the most outer tag, because it is a fragment
}

/**
 * Binding for prosemirror.
 *
 * @protected
 */
export class ProsemirrorBinding {
  /**
   * @param {YXmlFragment} yXmlFragment The bind source
   * @param {EditorView} prosemirrorView The target binding
   */
  constructor (yXmlFragment, prosemirrorView) {
    this.type = yXmlFragment
    this.prosemirrorView = prosemirrorView
    this.mux = createMutex()
    /**
     * @type {ProsemirrorMapping}
     */
    this.mapping = new Map()
    this._observeFunction = this._typeChanged.bind(this)
    this.y = yXmlFragment._y
    /**
     * current selection as relative positions in the Yjs model
     */
    this._relSelection = null
    this.y.on('beforeTransaction', e => {
      this._relSelection = {
        anchor: absolutePositionToRelativePosition(this.prosemirrorView.state.selection.anchor, yXmlFragment, this.mapping),
        head: absolutePositionToRelativePosition(this.prosemirrorView.state.selection.head, yXmlFragment, this.mapping)
      }
    })
    yXmlFragment.observeDeep(this._observeFunction)
  }
  _typeChanged (events, transaction) {
    if (events.length === 0) {
      return
    }
    console.info('new types:', transaction.newTypes.size, 'deleted types:', transaction.deletedStructs.size, transaction.newTypes, transaction.deletedStructs)
    this.mux(() => {
      const delStruct = (_, struct) => this.mapping.delete(struct)
      transaction.deletedStructs.forEach(struct => this.mapping.delete(struct))
      transaction.changedTypes.forEach(delStruct)
      transaction.changedParentTypes.forEach(delStruct)
      const fragmentContent = this.type.toArray().map(t => createNodeIfNotExists(t, this.prosemirrorView.state.schema, this.mapping)).filter(n => n !== null)
      const tr = this.prosemirrorView.state.tr.replace(0, this.prosemirrorView.state.doc.content.size, new PModel.Slice(new PModel.Fragment(fragmentContent), 0, 0))
      const relSel = this._relSelection
      if (relSel !== null &amp;&amp; relSel.anchor !== null &amp;&amp; relSel.head !== null) {
        const anchor = relativePositionToAbsolutePosition(this.type, relSel.anchor, this.mapping)
        const head = relativePositionToAbsolutePosition(this.type, relSel.head, this.mapping)
        if (anchor !== null &amp;&amp; head !== null) {
          tr.setSelection(TextSelection.create(tr.doc, anchor, head))
        }
      }
      this.prosemirrorView.updateState(this.prosemirrorView.state.apply(tr))
    })
  }
  _prosemirrorChanged (doc) {
    this.mux(() => {
      updateYFragment(this.type, doc.content, this.mapping)
    })
  }
  destroy () {
    this.type.unobserveDeep(this._observeFunction)
  }
}

/**
 * @privateMapping
 * @param {YXmlElement} el
 * @param {PModel.Schema} schema
 * @param {ProsemirrorMapping} mapping
 * @return {PModel.Node}
 */
export const createNodeIfNotExists = (el, schema, mapping) => {
  const node = mapping.get(el)
  if (node === undefined) {
    return createNodeFromYElement(el, schema, mapping)
  }
  return node
}

/**
 * @private
 * @param {YXmlElement} el
 * @param {PModel.Schema} schema
 * @param {ProsemirrorMapping} mapping
 * @return {PModel.Node | null} Returns node if node could be created. Otherwise it deletes the yjs type and returns null
 */
export const createNodeFromYElement = (el, schema, mapping) => {
  const children = []
  el.toArray().forEach(type => {
    if (type.constructor === YXmlElement) {
      const n = createNodeIfNotExists(type, schema, mapping)
      if (n !== null) {
        children.push(n)
      }
    } else {
      const ns = createTextNodesFromYText(type, schema, mapping)
      if (ns !== null) {
        ns.forEach(textchild => {
          if (textchild !== null) {
            children.push(textchild)
          }
        })
      }
    }
  })
  let node
  try {
    node = schema.node(el.nodeName.toLowerCase(), el.getAttributes(), children)
  } catch (e) {
    // an error occured while creating the node. This is probably a result because of a concurrent action.
    // delete the node and do not push to children
    el._y.transact(() => {
      el._delete(el._y, true)
    })
    return null
  }
  mapping.set(el, node)
  return node
}

/**
 * @private
 * @param {YText} text
 * @param {PModel.Schema} schema
 * @param {ProsemirrorMapping} mapping
 * @return {Array&lt;PModel.Node>}
 */
export const createTextNodesFromYText = (text, schema, mapping) => {
  const nodes = []
  const deltas = text.toDelta()
  try {
    for (let i = 0; i &lt; deltas.length; i++) {
      const delta = deltas[i]
      const marks = []
      for (let markName in delta.attributes) {
        marks.push(schema.mark(markName, delta.attributes[markName]))
      }
      nodes.push(schema.text(delta.insert, marks))
    }
    if (nodes.length > 0) {
      mapping.set(text, nodes[0]) // only map to first child, all following children are also considered bound to this type
    }
  } catch (e) {
    text._y.transact(() => {
      text._delete(text._y, true)
    })
    return null
  }
  return nodes
}

/**
 * @private
 * @param {PModel.Node} node
 * @param {ProsemirrorMapping} mapping
 * @return {YXmlElement | YText}
 */
export const createTypeFromNode = (node, mapping) => {
  let type
  if (node.isText) {
    type = new YText()
    const attrs = {}
    node.marks.forEach(mark => { attrs[mark.type.name] = mark.attrs })
    type.insert(0, node.text, attrs)
  } else {
    type = new YXmlElement(node.type.name)
    for (let key in node.attrs) {
      const val = node.attrs[key]
      if (val !== null) {
        type.setAttribute(key, val)
      }
    }
    const ins = []
    for (let i = 0; i &lt; node.childCount; i++) {
      ins.push(createTypeFromNode(node.child(i), mapping))
    }
    type.insert(0, ins)
  }
  mapping.set(type, node)
  return type
}

const equalAttrs = (pattrs, yattrs) => {
  const keys = Object.keys(pattrs).filter(key => pattrs[key] === null)
  let eq = keys.length === Object.keys(yattrs).filter(key => yattrs[key] === null).length
  for (let i = 0; i &lt; keys.length &amp;&amp; eq; i++) {
    const key = keys[i]
    eq = pattrs[key] === yattrs[key]
  }
  return eq
}

const equalYTextPText = (ytext, ptext) => {
  const d = ytext.toDelta()[0]
  return d.insert === ptext.text &amp;&amp; object.keys(d.attributes || {}).length === ptext.marks.length &amp;&amp; ptext.marks.every(mark => equalAttrs(d.attributes[mark.type.name], mark.attrs))
}

const equalYTypePNode = (ytype, pnode) =>
  ytype.constructor === YText
    ? equalYTextPText(ytype, pnode)
    : (matchNodeName(ytype, pnode) &amp;&amp; ytype.length === pnode.childCount &amp;&amp; equalAttrs(ytype.getAttributes(), pnode.attrs) &amp;&amp; ytype.toArray().every((ychild, i) => equalYTypePNode(ychild, pnode.child(i))))

const computeChildEqualityFactor = (ytype, pnode, mapping) => {
  const yChildren = ytype.toArray()
  const pChildCnt = pnode.childCount
  const yChildCnt = yChildren.length
  const minCnt = math.min(yChildCnt, pChildCnt)
  let left = 0
  let right = 0
  let foundMappedChild = false
  for (; left &lt; minCnt; left++) {
    const leftY = yChildren[left]
    const leftP = pnode.child(left)
    if (mapping.get(leftY) === leftP) {
      foundMappedChild = true// definite (good) match!
    } else if (!equalYTypePNode(leftY, leftP)) {
      break
    }
  }
  for (; left + right &lt; minCnt; right++) {
    const rightY = yChildren[yChildCnt - right - 1]
    const rightP = pnode.child(pChildCnt - right - 1)
    if (mapping.get(rightY) !== rightP) {
      foundMappedChild = true
    } else if (!equalYTypePNode(rightP, rightP)) {
      break
    }
  }
  return {
    equalityFactor: left + right,
    foundMappedChild
  }
}

/**
 * @private
 * @param {YXmlFragment} yDomFragment
 * @param {PModel.Node} pContent
 * @param {ProsemirrorMapping} mapping
 */
const updateYFragment = (yDomFragment, pContent, mapping) => {
  if (yDomFragment instanceof YXmlElement &amp;&amp; yDomFragment.nodeName.toLowerCase() !== pContent.type.name) {
    throw new Error('node name mismatch!')
  }
  mapping.set(yDomFragment, pContent)
  // update attributes
  if (yDomFragment instanceof YXmlElement) {
    const yDomAttrs = yDomFragment.getAttributes()
    const pAttrs = pContent.attrs
    for (let key in pAttrs) {
      if (pAttrs[key] !== null) {
        if (yDomAttrs[key] !== pAttrs[key]) {
          yDomFragment.setAttribute(key, pAttrs[key])
        }
      } else {
        yDomFragment.removeAttribute(key)
      }
    }
    // remove all keys that are no longer in pAttrs
    for (let key in yDomAttrs) {
      if (pAttrs[key] === undefined) {
        yDomFragment.removeAttribute(key)
      }
    }
  }
  // update children
  const pChildCnt = pContent.childCount
  const yChildren = yDomFragment.toArray()
  const yChildCnt = yChildren.length
  const minCnt = math.min(pChildCnt, yChildCnt)
  let left = 0
  let right = 0
  // find number of matching elements from left
  for (;left &lt; minCnt; left++) {
    const leftY = yChildren[left]
    const leftP = pContent.child(left)
    if (mapping.get(leftY) !== leftP) {
      if (equalYTypePNode(leftY, leftP)) {
        // update mapping
        mapping.set(leftY, leftP)
      } else {
        break
      }
    }
  }
  // find number of matching elements from right
  for (;right + left &lt; minCnt; right++) {
    const rightY = yChildren[yChildCnt - right - 1]
    const rightP = pContent.child(pChildCnt - right - 1)
    if (mapping.get(rightY) !== rightP) {
      if (equalYTypePNode(rightY, rightP)) {
        // update mapping
        mapping.set(rightY, rightP)
      } else {
        break
      }
    }
  }
  yDomFragment._y.transact(() => {
    // try to compare and update
    while (yChildCnt - left - right > 0 &amp;&amp; pChildCnt - left - right > 0) {
      const leftY = yChildren[left]
      const leftP = pContent.child(left)
      const rightY = yChildren[yChildCnt - right - 1]
      const rightP = pContent.child(pChildCnt - right - 1)
      if (leftY.constructor === YText &amp;&amp; leftP.isText) {
        if (!equalYTextPText(leftY, leftP)) {
          yDomFragment.delete(left, 1)
          yDomFragment.insert(left, [createTypeFromNode(leftP, mapping)])
        }
        left += 1
      } else {
        let updateLeft = matchNodeName(leftY, leftP)
        let updateRight = matchNodeName(rightY, rightP)
        if (updateLeft &amp;&amp; updateRight) {
          // decide which which element to update
          const equalityLeft = computeChildEqualityFactor(leftY, leftP, mapping)
          const equalityRight = computeChildEqualityFactor(rightY, rightP, mapping)
          if (equalityLeft.foundMappedChild &amp;&amp; !equalityRight.foundMappedChild) {
            updateRight = false
          } else if (!equalityLeft.foundMappedChild &amp;&amp; equalityRight.foundMappedChild) {
            updateLeft = false
          } else if (equalityLeft.equalityFactor &lt; equalityRight.equalityFactor) {
            updateLeft = false
          } else {
            updateRight = false
          }
        }
        if (updateLeft) {
          updateYFragment(leftY, leftP, mapping)
          left += 1
        } else if (updateRight) {
          updateYFragment(rightY, rightP, mapping)
          right += 1
        } else {
          yDomFragment.delete(left, 1)
          yDomFragment.insert(left, [createTypeFromNode(leftP, mapping)])
          left += 1
        }
      }
    }
    const yDelLen = yChildCnt - left - right
    if (yDelLen > 0) {
      yDomFragment.delete(left, yDelLen)
    }
    if (left + right &lt; pChildCnt) {
      const ins = []
      for (let i = left; i &lt; pChildCnt - right; i++) {
        ins.push(createTypeFromNode(pContent.child(i), mapping))
      }
      yDomFragment.insert(left, ins)
    }
  })
}

/**
 * @function
 * @param {YXmlElement} yElement
 * @param {any} pNode Prosemirror Node
 */
const matchNodeName = (yElement, pNode) => yElement.nodeName === pNode.type.name.toUpperCase()
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://user-images.githubusercontent.com/5553757/48975307-61efb100-f06d-11e8-9177-ee895e5916e5.png" style="width: 162px; height: 162px">
    <div class="footer-text">Shared Editing</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
