

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: provider/ydb/idbactions.js | yjs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="./style.css">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 162px; height: 162px">
        
            <a href="/" rel="noopener noreferrer" target="_blank">
                <img src="https://user-images.githubusercontent.com/5553757/48975307-61efb100-f06d-11e8-9177-ee895e5916e5.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">yjs</a></h1>
        
            <span class="version">v13.0.0-76</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
        <ol class="lnb-tab">
            <li id="api-tab">
                <a href="#"><h4>API</h4></a>
            </li>
            <li id="examples-tab">
                <a href="#"><h4>Examples</h4></a>
            </li>
        </ol>
    
    <div class="lnb-examples hidden"><h3>Examples</h3><ul><li><a href="tutorial-codemirror.html">CodeMirror Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="codemirror_sub"></div></li><li><a href="tutorial-dom.html">Dom Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="dom_sub"></div></li><li><a href="tutorial-prosemirror.html">ProseMirror Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="prosemirror_sub"></div></li><li><a href="tutorial-quill.html">Quill Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="quill_sub"></div></li><li><a href="tutorial-textarea.html">Textarea Binding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="textarea_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-bindings_dom.html">bindings/dom</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/dom_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-bindings_dom.html#.defaultFilter">defaultFilter</a></li><li><a href="module-bindings_dom.html#.domToType">domToType</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-bindings_dom.html#~DomFilter">DomFilter</a></li><li><a href="module-bindings_dom.html#~DomFilter">DomFilter</a></li><li><a href="module-bindings_dom.html#~FilterFunction">FilterFunction</a></li></ul></div></li><li><a href="module-bindings_prosemirror.html">bindings/prosemirror</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/prosemirror_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_prosemirror.html#.absolutePositionToRelativePosition">absolutePositionToRelativePosition</a></li><li><a href="module-bindings_prosemirror.html#.createNodeIfNotExists">createNodeIfNotExists</a></li><li><a href="module-bindings_prosemirror.html#.cursorPlugin">cursorPlugin</a></li><li><a href="module-bindings_prosemirror.html#.cursorPluginKey">cursorPluginKey</a></li><li><a href="module-bindings_prosemirror.html#.prosemirrorPlugin">prosemirrorPlugin</a></li><li><a href="module-bindings_prosemirror.html#.prosemirrorPluginKey">prosemirrorPluginKey</a></li><li><a href="module-bindings_prosemirror.html#.relativePositionToAbsolutePosition">relativePositionToAbsolutePosition</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-bindings_prosemirror.html#~matchNodeName">matchNodeName</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-bindings_prosemirror.html#~ProsemirrorMapping">ProsemirrorMapping</a></li></ul></div></li><li><a href="module-bindings_quill.html">bindings/quill</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/quill_sub"></div></li><li><a href="module-bindings_textarea.html">bindings/textarea</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/textarea_sub"></div></li><li><a href="module-provider_websocket.html">provider/websocket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/websocket_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_websocket.html#~permissionDeniedHandler">permissionDeniedHandler</a></li><li><a href="module-provider_websocket.html#~readMessage">readMessage</a></li></ul></div></li><li><a href="module-provider_websocket_server.html">provider/websocket/server</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/websocket/server_sub"></div></li><li><a href="module-provider_ydb.html">provider/ydb</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/ydb_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-provider_ydb.html#._broadcastYdbCUConfConfirmed">_broadcastYdbCUConfConfirmed</a></li><li><a href="module-provider_ydb.html#._broadcastYdbCUConfCreated">_broadcastYdbCUConfCreated</a></li><li><a href="module-provider_ydb.html#._broadcastYdbRemoteOffsetConfirmed">_broadcastYdbRemoteOffsetConfirmed</a></li><li><a href="module-provider_ydb.html#._broadcastYdbRemoteOffsetReceived">_broadcastYdbRemoteOffsetReceived</a></li><li><a href="module-provider_ydb.html#._broadcastYdbSyncFromServer">_broadcastYdbSyncFromServer</a></li><li><a href="module-provider_ydb.html#._broadcastYdbSyncingRoomsToServer">_broadcastYdbSyncingRoomsToServer</a></li><li><a href="module-provider_ydb.html#.clear">clear</a></li><li><a href="module-provider_ydb.html#.confirmClient">confirmClient</a></li><li><a href="module-provider_ydb.html#.confirmSubscription">confirmSubscription</a></li><li><a href="module-provider_ydb.html#.createSub">createSub</a></li><li><a href="module-provider_ydb.html#.createTransaction">createTransaction</a></li><li><a href="module-provider_ydb.html#.createUpdate">createUpdate</a></li><li><a href="module-provider_ydb.html#.createYdbClient">createYdbClient</a></li><li><a href="module-provider_ydb.html#.get">get</a></li><li><a href="module-provider_ydb.html#.getRoomData">getRoomData</a></li><li><a href="module-provider_ydb.html#.getRoomDataWithoutCU">getRoomDataWithoutCU</a></li><li><a href="module-provider_ydb.html#.getRoomMetas">getRoomMetas</a></li><li><a href="module-provider_ydb.html#.getUnconfirmedUpdates">getUnconfirmedUpdates</a></li><li><a href="module-provider_ydb.html#.openDB">openDB</a></li><li><a href="module-provider_ydb.html#.publishAll">publishAll</a></li><li><a href="module-provider_ydb.html#.publishRoomData">publishRoomData</a></li><li><a href="module-provider_ydb.html#.readMessage">readMessage</a></li><li><a href="module-provider_ydb.html#.send">send</a></li><li><a href="module-provider_ydb.html#.subscribeRoomData">subscribeRoomData</a></li><li><a href="module-provider_ydb.html#.update">update</a></li><li><a href="module-provider_ydb.html#.writeClientUnconfirmed">writeClientUnconfirmed</a></li><li><a href="module-provider_ydb.html#.writeConfirmedByHost">writeConfirmedByHost</a></li><li><a href="module-provider_ydb.html#.writeHostUnconfirmed">writeHostUnconfirmed</a></li><li><a href="module-provider_ydb.html#.writeHostUnconfirmedByClient">writeHostUnconfirmedByClient</a></li><li><a href="module-provider_ydb.html#~datasubs">datasubs</a></li><li><a href="module-provider_ydb.html#~ydbinstances">ydbinstances</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_ydb.html#~checkTestClients">checkTestClients</a></li><li><a href="module-provider_ydb.html#~decodeHUKey">decodeHUKey</a></li><li><a href="module-provider_ydb.html#~encodeHUKey">encodeHUKey</a></li><li><a href="module-provider_ydb.html#~encodeMetaValue">encodeMetaValue</a></li><li><a href="module-provider_ydb.html#~getStoreCo">getStoreCo</a></li><li><a href="module-provider_ydb.html#~getStoreCU">getStoreCU</a></li><li><a href="module-provider_ydb.html#~getStoreHU">getStoreHU</a></li><li><a href="module-provider_ydb.html#~getStoreUS">getStoreUS</a></li><li><a href="module-provider_ydb.html#~getTestClient">getTestClient</a></li><li><a href="module-provider_ydb.html#~initWS">initWS</a></li><li><a href="module-provider_ydb.html#~update">update</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-provider_ydb.html#~HUTableKey">HUTableKey</a></li><li><a href="module-provider_ydb.html#~RoomAndOffset">RoomAndOffset</a></li><li><a href="module-provider_ydb.html#~RoomMeta">RoomMeta</a></li><li><a href="module-provider_ydb.html#~RoomState">RoomState</a></li><li><a href="module-provider_ydb.html#~Sub">Sub</a></li><li><a href="module-provider_ydb.html#~SubDef">SubDef</a></li><li><a href="module-provider_ydb.html#~SyncState">SyncState</a></li></ul></div></li><li><a href="module-structs.html">structs</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:structs_sub"></div></li><li><a href="module-types.html">types</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types_sub"><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-types.html#~CSS_Selector">CSS_Selector</a></li><li><a href="module-types.html#~CSS_Selector">CSS_Selector</a></li><li><a href="module-types.html#~Delta">Delta</a></li><li><a href="module-types.html#~domFilter">domFilter</a></li><li><a href="module-types.html#~TextAttributes">TextAttributes</a></li></ul></div></li><li><a href="module-utils.html">utils</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:utils_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="module-bindings_dom.DomBinding.html">DomBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/dom.DomBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_dom.DomBinding.html#domToType">domToType</a></li><li><a href="module-bindings_dom.DomBinding.html#filter">filter</a></li><li><a href="module-bindings_dom.DomBinding.html#target">target</a></li><li><a href="module-bindings_dom.DomBinding.html#type">type</a></li><li><a href="module-bindings_dom.DomBinding.html#typeToDom">typeToDom</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-bindings_dom.DomBinding.html#destroy">destroy</a></li><li><a href="module-bindings_dom.DomBinding.html#setFilter">setFilter</a></li></ul></div></li><li><a href="module-bindings_prosemirror.ProsemirrorBinding.html">ProsemirrorBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/prosemirror.ProsemirrorBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_prosemirror.ProsemirrorBinding.html#_relSelection">_relSelection</a></li><li><a href="module-bindings_prosemirror.ProsemirrorBinding.html#mapping">mapping</a></li></ul></div></li><li><a href="module-bindings_quill.QuillBinding.html">QuillBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/quill.QuillBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_quill.QuillBinding.html#target">target</a></li><li><a href="module-bindings_quill.QuillBinding.html#type">type</a></li></ul></div></li><li><a href="module-bindings_textarea.CodeMirrorBinding.html">CodeMirrorBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/textarea.CodeMirrorBinding_sub"></div></li><li><a href="module-bindings_textarea.TextareaBinding.html">TextareaBinding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:bindings/textarea.TextareaBinding_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-bindings_textarea.TextareaBinding.html#target">target</a></li><li><a href="module-bindings_textarea.TextareaBinding.html#type">type</a></li></ul></div></li><li><a href="module-provider_websocket.WebsocketProvider.html">WebsocketProvider</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/websocket.WebsocketProvider_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-provider_websocket.WebsocketProvider.html#docs">docs</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_websocket.WebsocketProvider.html#get">get</a></li></ul></div></li><li><a href="module-provider_ydb.YdbClient.html">YdbClient</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:provider/ydb.YdbClient_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-provider_ydb.YdbClient.html#clientUnconfirmedStates">clientUnconfirmedStates</a></li><li><a href="module-provider_ydb.YdbClient.html#roomStates">roomStates</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-provider_ydb.YdbClient.html#getY">getY</a></li></ul></div></li><li><a href="module-structs.Type.html">Type</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:structs.Type_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-structs.Type.html#_first">_first</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-structs.Type.html#getPathTo">getPathTo</a></li><li><a href="module-structs.Type.html#observe">observe</a></li><li><a href="module-structs.Type.html#observeDeep">observeDeep</a></li><li><a href="module-structs.Type.html#toJSON">toJSON</a></li><li><a href="module-structs.Type.html#unobserve">unobserve</a></li><li><a href="module-structs.Type.html#unobserveDeep">unobserveDeep</a></li></ul></div></li><li><a href="module-types.YArray.html">YArray</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YArray_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YArray.html#delete">delete</a></li><li><a href="module-types.YArray.html#forEach">forEach</a></li><li><a href="module-types.YArray.html#get">get</a></li><li><a href="module-types.YArray.html#insert">insert</a></li><li><a href="module-types.YArray.html#map">map</a></li><li><a href="module-types.YArray.html#push">push</a></li><li><a href="module-types.YArray.html#toArray">toArray</a></li><li><a href="module-types.YArray.html#toJSON">toJSON</a></li></ul></div></li><li><a href="module-types.YArrayEvent.html">YArrayEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YArrayEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-types.YArrayEvent.html#addedElements">addedElements</a></li><li><a href="module-types.YArrayEvent.html#removedElements">removedElements</a></li></ul></div></li><li><a href="module-types.YMap.html">YMap</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YMap_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YMap.html#delete">delete</a></li><li><a href="module-types.YMap.html#get">get</a></li><li><a href="module-types.YMap.html#has">has</a></li><li><a href="module-types.YMap.html#keys">keys</a></li><li><a href="module-types.YMap.html#set">set</a></li><li><a href="module-types.YMap.html#toJSON">toJSON</a></li></ul></div></li><li><a href="module-types.YMapEvent.html">YMapEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YMapEvent_sub"></div></li><li><a href="module-types.YText.html">YText</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YText_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YText.html#applyDelta">applyDelta</a></li><li><a href="module-types.YText.html#delete">delete</a></li><li><a href="module-types.YText.html#format">format</a></li><li><a href="module-types.YText.html#insert">insert</a></li><li><a href="module-types.YText.html#insertEmbed">insertEmbed</a></li><li><a href="module-types.YText.html#toDelta">toDelta</a></li><li><a href="module-types.YText.html#toString">toString</a></li></ul></div></li><li><a href="module-types.YXmlElement.html">YXmlElement</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlElement_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlElement.html#getAttribute">getAttribute</a></li><li><a href="module-types.YXmlElement.html#getAttributes">getAttributes</a></li><li><a href="module-types.YXmlElement.html#removeAttribute">removeAttribute</a></li><li><a href="module-types.YXmlElement.html#setAttribute">setAttribute</a></li><li><a href="module-types.YXmlElement.html#toDom">toDom</a></li><li><a href="module-types.YXmlElement.html#toDomString">toDomString</a></li></ul></div></li><li><a href="module-types.YXmlEvent.html">YXmlEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-types.YXmlEvent.html#_transaction">_transaction</a></li><li><a href="module-types.YXmlEvent.html#attributesChanged">attributesChanged</a></li><li><a href="module-types.YXmlEvent.html#childListChanged">childListChanged</a></li><li><a href="module-types.YXmlEvent.html#remote">remote</a></li></ul></div></li><li><a href="module-types.YXmlFragment.html">YXmlFragment</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlFragment_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlFragment.html#createTreeWalker">createTreeWalker</a></li><li><a href="module-types.YXmlFragment.html#querySelector">querySelector</a></li><li><a href="module-types.YXmlFragment.html#querySelectorAll">querySelectorAll</a></li><li><a href="module-types.YXmlFragment.html#toDom">toDom</a></li><li><a href="module-types.YXmlFragment.html#toDomString">toDomString</a></li></ul></div></li><li><a href="module-types.YXmlHook.html">YXmlHook</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlHook_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlHook.html#toDom">toDom</a></li></ul></div></li><li><a href="module-types.YXmlText.html">YXmlText</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlText_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlText.html#toDom">toDom</a></li></ul></div></li><li><a href="module-types.YXmlTreeWalker.html">YXmlTreeWalker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:types.YXmlTreeWalker_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-types.YXmlTreeWalker.html#next">next</a></li></ul></div></li><li><a href="module-utils.YEvent.html">YEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:utils.YEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-utils.YEvent.html#currentTarget">currentTarget</a></li><li><a href="module-utils.YEvent.html#path">path</a></li><li><a href="module-utils.YEvent.html#target">target</a></li></ul></div></li><li><a href="UndoManager.html">UndoManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UndoManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="UndoManager.html#flushChanges">flushChanges</a></li><li><a href="UndoManager.html#redo">redo</a></li><li><a href="UndoManager.html#undo">undo</a></li></ul></div></li><li><a href="Y.html">Y</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Y_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Y.html#define">define</a></li><li><a href="Y.html#destroy">destroy</a></li><li><a href="Y.html#exportModel">exportModel</a></li><li><a href="Y.html#get">get</a></li><li><a href="Y.html#importModel">importModel</a></li><li><a href="Y.html#transact">transact</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3><a href="global.html">Global</a></h3></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module provider/ydb
 */

/* eslint-env browser */

/**
 * Naming conventions:
 * * ydb: Think of ydb as a federated set of servers. This is not yet true, but we will eventually get there. With this assumption come some challenges with the client
 * * ydb instance: A single ydb instance that this ydb-client connects to
 * * (room) host: Exactly one ydb instance controls a room at any time. The ownership may change over time. The host of a room is the ydb instance that owns it. This is not necessarily the instance we connect to.
 * * room session id: An random id that is assigned to a room. When the server dies unexpectedly, we can conclude which data is missing and send it to the server (or delete it and prevent duplicate content)
 * * update: An ArrayBuffer of binary data. Neither Ydb nor Ydb-client care about the content of update. Updates may be appended to each other.
 *
 * The database has four tables:
 *
 * CU "client-unconfirmed" confid -> room, update
 *   - The client writes to this table when it creates an update.
 *   - Then it sends an update to the host with the generated confid
 *   - In case the host doesn't confirm that it received this update, it is sent again on next sync
 * HU "host-unconfirmed" room, offset -> update
 *   - Updates from the host are written to this table
 *   - When host confirms that an unconfirmed update was persisted, the update is written to the Co table
 *   - When client sync to host and the room session ids don't match, all host-unconfirmed messages are sent to host
 * Co "confirmed":
 *   data:{room} -> update
 *     - this field holds confirmed room updates
 *   meta:{room} -> room session id, confirmed offset
 *     - this field holds metadata about the room
 * US "unconfirmed-subscriptions" room -> _
 *   - Subscriptions sent to the server, but didn't receive confirmation yet
 *   - Either a room is in US or in Co
 *   - A client may update a room when the room is in either US or Co
 */

import * as encoding from '../../lib/encoding.js'
import * as decoding from '../../lib/decoding.js'
import * as idb from '../../lib/idb.js'
import * as globals from '../../lib/globals.js'
import * as message from './message.js'

/**
 * Get 'client-unconfirmed' store from transaction
 * @param {IDBTransaction} t
 * @return {IDBObjectStore}
 */
const getStoreCU = t => idb.getStore(t, STORE_CU)
/**
 * Get 'host-unconfirmed' store from transaction
 * @param {IDBTransaction} t
 * @return {IDBObjectStore}
 */
const getStoreHU = t => idb.getStore(t, STORE_HU)
/**
 * Get 'confirmed' store from transaction
 * @param {IDBTransaction} t
 * @return {IDBObjectStore}
 */
const getStoreCo = t => idb.getStore(t, STORE_CO)

/**
 * Get `unconfirmed-subscriptions` store from transaction
 * @param {IDBTransaction} t
 * @return {IDBObjectStore}
 */
const getStoreUS = t => idb.getStore(t, STORE_US)

/**
 * @param {string} room
 * @param {number} offset
 * @return {HUTableKey}
 */
const encodeHUKey = (room, offset) => [room, offset]

/**
 * Array of length 2: [string, number]
 * @typedef HUTableKey
 * @type {any}
 */

/**
 * @typedef RoomAndOffset
 * @type {Object}
 * @property {string} room
 * @property {number} offset Received offsets (including offsets that are not yet confirmed)
 */

/**
 * @param {HUTableKey} key
 * @return {RoomAndOffset}
 */
const decodeHUKey = key => {
  return {
    room: key[0],
    offset: key[1]
  }
}

const getCoMetaKey = room => 'meta:' + room
const getCoDataKey = room => 'data:' + room

const STORE_CU = 'client-unconfirmed'
const STORE_US = 'unconfirmed-subscriptions'
const STORE_CO = 'confirmed'
const STORE_HU = 'host-unconfirmed'

/**
 * @param {string} dbNamespace
 * @return {Promise&lt;IDBDatabase>}
 */
export const openDB = dbNamespace => idb.openDB(dbNamespace, db => idb.createStores(db, [
  [STORE_CU, { autoIncrement: true }],
  [STORE_HU],
  [STORE_CO],
  [STORE_US]
]))

export const deleteDB = name => idb.deleteDB(name)

/**
 * Create a new IDBTransaction accessing all object stores. Normally we should care that we can access object stores in parallel.
 * But this is not possible in ydb-client since at least two object stores are requested in every IDB change.
 * @param {IDBDatabase} db
 * @return {IDBTransaction}
 */
export const createTransaction = db => db.transaction([STORE_CU, STORE_HU, STORE_CO, STORE_US], 'readwrite')

/**
 * Write an update to the db after the client created it. This update is not yet received by the host.
 * This function returns a client confirmation number. The confirmation number must be send to the host so it can identify the update,
 * and we can move the update to HU when it is confirmed (@see writeHostUnconfirmedByClient)
 * @param {IDBTransaction} t
 * @param {String} room
 * @param {ArrayBuffer} update
 * @return {Promise&lt;number>} client confirmation number
 */
export const writeClientUnconfirmed = (t, room, update) => {
  const encoder = encoding.createEncoder()
  encoding.writeVarString(encoder, room)
  encoding.writeArrayBuffer(encoder, update)
  return idb.addAutoKey(getStoreCU(t), encoding.toBuffer(encoder))
}

/**
 * Get all updates that are not yet confirmed by host.
 * @param {IDBTransaction} t
 * @return {Promise&lt;ArrayBuffer>} All update messages as a single ArrayBuffer
 */
export const getUnconfirmedUpdates = t => {
  const encoder = encoding.createEncoder()
  return idb.iterate(getStoreCU(t), null, (value, clientConf) => {
    const decoder = decoding.createDecoder(value)
    const room = decoding.readVarString(decoder)
    const update = decoding.readTail(decoder)
    encoding.writeArrayBuffer(encoder, message.createUpdate(room, update, clientConf))
  }).then(() => encoding.toBuffer(encoder))
}

/**
 * The host confirms that it received and persisted an update. The update can be safely removed from CU.
 * It is necessary to call this function in case that the client disconnected before the host could send `writeHostUnconfirmedByClient`.
 * @param {IDBTransaction} t
 * @param {number} clientConf
 * @return {Promise}
 */
export const confirmClient = (t, clientConf) => idb.del(getStoreCU(t), idb.createIDBKeyRangeUpperBound(clientConf, false))

/**
 * The host confirms that it received and broadcasted an update sent from this client.
 * Calling this method does not confirm that the update has been persisted by the server.
 *
 * Other clients will receive an update with `writeHostUnconfirmed`. Since this client created the update, it only receives a confirmation. So
 * we can simply move the update from CU to HU.
 *
 * @param {IDBTransaction} t
 * @param {number} clientConf The client confirmation number that identifies the update
 * @param {number} offset The offset with wich the server will store the information
 */
export const writeHostUnconfirmedByClient = (t, clientConf, offset) => idb.get(getStoreCU(t), clientConf).then(roomAndUpdate => {
  const decoder = decoding.createDecoder(roomAndUpdate)
  const room = decoding.readVarString(decoder)
  const update = decoding.readTail(decoder)
  return writeHostUnconfirmed(t, room, offset, update).then(() =>
    idb.del(getStoreCU(t), clientConf)
  )
})

/**
 * The host broadcasts an update created by another client. It assures that the update will eventually be persisted with
 * `offset`. Calling this function does not imply that the update was persisted by the host. In case of mismatching room session ids
 * the updates in HU will be sent to the server.
 *
 * @param {IDBTransaction} t
 * @param {String} room
 * @param {number} offset
 * @param {ArrayBuffer} update
 * @return {Promise}
 */
export const writeHostUnconfirmed = (t, room, offset, update) => idb.put(getStoreHU(t), update, encodeHUKey(room, offset))

/**
 * The host confirms that it persisted updates up until (including) offset. updates may be moved from HU to Co.
 *
 * @param {IDBTransaction} t
 * @param {String} room
 * @param {number} offset Inclusive range [0, offset - 1] has been stored to host
 */
export const writeConfirmedByHost = (t, room, offset) => {
  const co = getStoreCo(t)
  return globals.pall([idb.get(co, getCoDataKey(room)), idb.get(co, getCoMetaKey(room))]).then(async arr => {
    const data = arr[0]
    const meta = decodeMetaValue(arr[1])
    const dataEncoder = encoding.createEncoder()
    if (meta.offset >= offset) {
      return // nothing to do
    }
    encoding.writeArrayBuffer(dataEncoder, data)
    const hu = getStoreHU(t)
    const huKeyRange = idb.createIDBKeyRangeBound(encodeHUKey(room, 0), encodeHUKey(room, offset), false, false)
    return idb.iterate(hu, huKeyRange, (value, _key) => {
      const key = decodeHUKey(_key) // @kevin _key is an array. remove decodeHUKey functions
      if (key.room === room &amp;&amp; key.offset &lt;= offset) {
        encoding.writeArrayBuffer(dataEncoder, value)
      }
    }).then(() => {
      globals.pall([idb.put(co, encodeMetaValue(meta.rsid, offset), getCoMetaKey(room)), idb.put(co, encoding.toBuffer(dataEncoder), getCoDataKey(room)), idb.del(hu, huKeyRange)])
    })
  })
}

/**
 * @typedef RoomMeta
 * @type {Object}
 * @property {string} room
 * @property {number} rsid Room session id
 * @property {number} offset Received offsets (including offsets that are not yet confirmed)
 */

/**
 * Get all meta information for all rooms.
 *
 * @param {IDBTransaction} t
 * @return {Promise&lt;Array&lt;RoomMeta>>}
 */
export const getRoomMetas = t => {
  // const result = []
  const storeCo = getStoreCo(t)
  const coQuery = idb.createIDBKeyRangeLowerBound('meta:', false)
  return globals.pall([idb.getAll(storeCo, coQuery), idb.getAllKeys(storeCo, coQuery)]).then(([metaValues, metaKeys]) => globals.pall(metaValues.map((metavalue, i) => {
    const room = metaKeys[i].slice(5)
    const { rsid, offset } = decodeMetaValue(metavalue)
    return {
      room,
      rsid,
      offset: offset
    }
  })))
  /*
  return idb.iterate(getStoreCo(t), idb.createIDBKeyRangeLowerBound('meta:', false), (metavalue, metakey) =>
    idb.getAllKeys(hu, idb.createIDBKeyRangeBound(encodeHUKey(metakey.slice(5), 0), encodeHUKey(metakey.slice(5), 2 ** 32), false, false)).then(keys => {
      const { rsid, offset } = decodeMetaValue(metavalue)
      result.push({
        room: metakey.slice(5),
        rsid,
        offset: keys.reduce((cur, key) => math.max(decodeHUKey(key).offset, cur), offset)
      })
    })
  ).then(() => globals.presolve(result))
  */
}

export const getRoomMeta = (t, room) =>
  idb.get(getStoreCo(t), getCoMetaKey(room))

/**
 * Get all data from idb, excluding unconfirmed updates.
 * TODO: include updates in CU
 * @param {IDBTransaction} t
 * @param {string} room
 * @return {Promise&lt;ArrayBuffer>}
 */
export const getRoomDataWithoutCU = (t, room) => globals.pall([idb.get(getStoreCo(t), 'data:' + room), idb.getAll(getStoreHU(t), idb.createIDBKeyRangeBound(encodeHUKey(room, 0), encodeHUKey(room, 2 ** 32), false, false))]).then(([data, updates]) => {
  const encoder = encoding.createEncoder()
  encoding.writeArrayBuffer(encoder, data || new Uint8Array(0))
  updates.forEach(update => encoding.writeArrayBuffer(encoder, update))
  return encoding.toBuffer(encoder)
})

/**
 * Get all data from idb, including unconfirmed updates.
 * TODO: include updates in CU
 * @param {IDBTransaction} t
 * @param {string} room
 * @return {Promise&lt;ArrayBuffer>}
 */
export const getRoomData = (t, room) => globals.pall([idb.get(getStoreCo(t), 'data:' + room), idb.getAll(getStoreHU(t), idb.createIDBKeyRangeBound(encodeHUKey(room, 0), encodeHUKey(room, 2 ** 32), false, false)), idb.getAll(getStoreCU(t))]).then(([data, updates, cuUpdates]) => {
  const encoder = encoding.createEncoder()
  encoding.writeArrayBuffer(encoder, data || new Uint8Array(0))
  updates.forEach(update => encoding.writeArrayBuffer(encoder, update))
  cuUpdates.forEach(roomAndUpdate => {
    const decoder = decoding.createDecoder(roomAndUpdate)
    if (decoding.readVarString(decoder) === room) {
      encoding.writeArrayBuffer(encoder, decoding.readTail(decoder))
    }
  })
  return encoding.toBuffer(encoder)
})

const decodeMetaValue = buffer => {
  const decoder = decoding.createDecoder(buffer)
  const rsid = decoding.readVarUint(decoder)
  const offset = decoding.readVarUint(decoder)
  return {
    rsid, offset
  }
}
/**
 * @param {number} rsid room session id
 * @param {number} offset
 * @return {ArrayBuffer}
 */
const encodeMetaValue = (rsid, offset) => {
  const encoder = encoding.createEncoder()
  encoding.writeVarUint(encoder, rsid)
  encoding.writeVarUint(encoder, offset)
  return encoding.toBuffer(encoder)
}

const writeInitialCoEntry = (t, room, roomsessionid, offset) => globals.pall([
  idb.put(getStoreCo(t), encodeMetaValue(roomsessionid, offset), getCoMetaKey(room)),
  idb.put(getStoreCo(t), globals.createArrayBufferFromArray([]), getCoDataKey(room))
])

const _confirmSub = (t, metaval, sub) => {
  if (metaval === undefined) {
    return writeInitialCoEntry(t, sub.room, sub.rsid, sub.offset).then(() => idb.del(getStoreUS(t), sub.room)).then(() => null)
  }
  const meta = decodeMetaValue(metaval)
  if (meta.rsid !== sub.rsid) {
    // TODO: Yjs sync with server here
    // get all room data (without CU) and save it as a client update. Then remove all data
    return getRoomDataWithoutCU(t, sub.room)
      .then(roomdata =>
        writeClientUnconfirmed(t, sub.room, roomdata)
          .then(clientConf => message.createUpdate(sub.room, roomdata, clientConf))
          .then(update =>
            writeInitialCoEntry(t, sub.room, sub.rsid, sub.offset).then(() => update)
          )
      )
  } else if (meta.offset &lt; sub.offset) {
    return writeConfirmedByHost(t, sub.room, sub.offset).then(() => null)
  } else {
    // nothing needs to happen
    return null
  }
}

/**
 * @typedef Sub
 * @type {Object}
 * @property {string} room room name
 * @property {number} rsid room session id
 * @property {number} offset
 */

/**
 * Set the initial room data. Overwrites initial data if there is any!
 * @param {IDBTransaction} t
 * @param {Sub} sub
 * @return {Promise&lt;ArrayBuffer?>} Message to send to server
 */
export const confirmSubscription = (t, sub) => idb.get(getStoreCo(t), getCoMetaKey(sub.room)).then(metaval => _confirmSub(t, metaval, sub))

export const confirmSubscriptions = (t, subs) => idb.getAllKeysValues(getStoreCo(t), idb.createIDBKeyRangeLowerBound('meta:', false)).then(kvs => {
  const ps = []
  const subMap = new Map()
  subs.forEach(sub => subMap.set(sub.room, sub))
  for (let i = 0, len = kvs.length; i &lt; len; i++) {
    const kv = kvs[i]
    const kvroom = kv.k.slice(5)
    const exSub = subMap.get(kvroom)
    if (exSub !== undefined) {
      subMap.delete(kvroom)
      ps.push(_confirmSub(t, kv.v, exSub))
    }
  }
  // all remaining elements in subMap do not exist yet in Co.
  subMap.forEach(nonexSub => ps.push(_confirmSub(t, undefined, nonexSub)))
  return ps
})

export const writeUnconfirmedSubscription = (t, room) => idb.put(getStoreUS(t), true, room)

export const getUnconfirmedSubscriptions = t => idb.getAllKeys(getStoreUS(t))
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://user-images.githubusercontent.com/5553757/48975307-61efb100-f06d-11e8-9177-ee895e5916e5.png" style="width: 162px; height: 162px">
    <div class="footer-text">Shared Editing</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
